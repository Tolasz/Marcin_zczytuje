import{C as d,G as h,T as y}from"./index-DuatYoAD.js";import{o as n,a as c,n as l,s as p,t as u}from"./types-0I2BUTGt.js";const f=n({cellSize:l().int().positive(),width:l().int().positive(),height:l().int().positive(),layers:c(n({name:p(),tiles:c(u([l().int(),l().int()]))}))});class g extends d{gridGfx=new h;tilesGfx=new h;hud=new y({text:"",style:{fontFamily:"Arial",fontSize:12,fill:16777215}});cellSize;mapWidth;mapHeight;layers=[{name:"Ground",tiles:new Set},{name:"Objects",tiles:new Set}];activeLayerIndex=0;undoStack=[];redoStack=[];isActive=!1;capturePointer=!1;constructor(t,e,i=32){super(),this.eventMode="static",this.cursor="crosshair",this.sortableChildren=!0,this.mapWidth=t,this.mapHeight=e,this.cellSize=i,this.addChild(this.gridGfx),this.addChild(this.tilesGfx),this.hud.zIndex=1e3,this.addChild(this.hud),this.layout(),this.drawGrid(),this.updateHud(),this.on("pointerdown",this.onPointerDown),this.on("pointermove",this.onPointerMove),this.on("pointerup",()=>this.capturePointer=!1),window.addEventListener("keydown",this.onKeyDown)}destroy(t){super.destroy(t),window.removeEventListener("keydown",this.onKeyDown)}attach(t){this.parent!==t&&t.addChild(this)}toggle(){this.isActive=!this.isActive,this.visible=this.isActive,document.body.setAttribute("data-editor",this.isActive?"active":"inactive"),this.isActive&&this.updateDomCounters()}open(){this.isActive||this.toggle()}close(){this.isActive&&this.toggle()}clear(){for(const t of this.layers)t.tiles.clear();this.undoStack=[],this.redoStack=[],this.redrawTiles(),this.updateDomCounters()}exportJSON(){const t={cellSize:this.cellSize,width:this.mapWidth,height:this.mapHeight,layers:this.layers.map(e=>({name:e.name,tiles:[...e.tiles].map(i=>this.keyToXY(i))}))};return JSON.stringify(t)}importJSON(t){const e=f.parse(JSON.parse(t));this.clear(),e.cellSize,this.cellSize;for(let i=0;i<e.layers.length;i+=1){const s=e.layers[i],o=this.layers[i]??this.layers[0];for(const[r,a]of s.tiles)o.tiles.add(this.xyToKey(r,a))}this.redrawTiles(),this.updateDomCounters()}saveToStorage(t="editor.map"){localStorage.setItem(t,this.exportJSON()),this.updateDomCounters()}loadFromStorage(t="editor.map"){const e=localStorage.getItem(t);e&&this.importJSON(e)}undo(){const t=this.undoStack.pop();t&&(this.applyInverse(t),this.redoStack.push(t),this.redrawTiles(),this.updateDomCounters())}redo(){const t=this.redoStack.pop();t&&(this.apply(t),this.undoStack.push(t),this.redrawTiles(),this.updateDomCounters())}onPointerDown=t=>{if(!this.isActive)return;this.capturePointer=!0;const{x:e,y:i}=t.global;this.toggleTileAt(e,i)};onPointerMove=t=>{if(!this.isActive||!this.capturePointer)return;const{x:e,y:i}=t.global;this.toggleTileAt(e,i)};onKeyDown=t=>{if(!this.isActive&&t.code!=="KeyE")return;const e=t.ctrlKey||t.metaKey;if(t.code==="KeyE"&&!e){this.toggle(),t.preventDefault();return}this.isActive&&(e&&t.code==="KeyS"?(this.saveToStorage(),t.preventDefault()):e&&t.code==="KeyO"?(this.loadFromStorage(),t.preventDefault()):e&&t.code==="KeyN"?(this.clear(),t.preventDefault()):e&&t.code==="KeyZ"?(this.undo(),t.preventDefault()):e&&(t.code==="KeyY"||t.shiftKey&&t.code==="KeyZ")?(this.redo(),t.preventDefault()):t.code==="Digit1"?(this.activeLayerIndex=0,this.updateHud()):t.code==="Digit2"?(this.activeLayerIndex=1,this.updateHud()):t.code==="Escape"&&this.close())};toggleTileAt(t,e){const i=Math.floor(t/this.cellSize),s=Math.floor(e/this.cellSize),o=this.xyToKey(i,s),r=this.layers[this.activeLayerIndex];r.tiles.has(o)?(r.tiles.delete(o),this.undoStack.push({type:"remove",x:i,y:s,layer:this.activeLayerIndex}),this.redoStack=[]):(r.tiles.add(o),this.undoStack.push({type:"place",x:i,y:s,layer:this.activeLayerIndex}),this.redoStack=[]),this.redrawTiles(),this.updateDomCounters()}apply(t){const e=this.xyToKey(t.x,t.y),i=this.layers[t.layer];t.type==="place"?i.tiles.add(e):i.tiles.delete(e)}applyInverse(t){this.apply({...t,type:t.type==="place"?"remove":"place"})}redrawTiles(){const t=this.tilesGfx.clear();for(let e=0;e<this.layers.length;e+=1){const i=this.layers[e],s=e===0?6728294:11167334;for(const o of i.tiles){const[r,a]=this.keyToXY(o);t.rect(r*this.cellSize,a*this.cellSize,this.cellSize,this.cellSize).fill(s)}}}drawGrid(){const t=this.gridGfx.clear();t.alpha=.4;const e=Math.floor(this.mapWidth/this.cellSize),i=Math.floor(this.mapHeight/this.cellSize);for(let s=0;s<=e;s+=1)t.moveTo(s*this.cellSize,0),t.lineTo(s*this.cellSize,i*this.cellSize);for(let s=0;s<=i;s+=1)t.moveTo(0,s*this.cellSize),t.lineTo(e*this.cellSize,s*this.cellSize);t.stroke({width:1,color:16777215})}layout(){this.hitArea={x:0,y:0,width:this.mapWidth,height:this.mapHeight},this.hud.x=8,this.hud.y=8}updateHud(){this.hud.text=`Editor â€” Layer ${this.activeLayerIndex+1}/${this.layers.length} (${this.layers[this.activeLayerIndex].name})  |  Ctrl+S Save  Ctrl+O Load  Ctrl+N Clear  Esc Close`}updateDomCounters(){const t=this.layers.reduce((e,i)=>e+i.tiles.size,0);document.body.setAttribute("data-editor-tiles",String(t))}xyToKey(t,e){return`${t},${e}`}keyToXY(t){const[e,i]=t.split(",");return[Number(e),Number(i)]}}export{g as EditorOverlay,f as TileMapSchema,g as default};
