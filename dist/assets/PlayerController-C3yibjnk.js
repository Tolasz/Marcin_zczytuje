import{P as b}from"./Player-BgmGi5Hd.js";import{p as g}from"./index-DuatYoAD.js";function u(i,t){return i.x<t.x+t.w&&i.x+i.w>t.x&&i.y<t.y+t.h&&i.y+i.h>t.y}function D(i,t){if(!u(i,t))return null;const m=t.x+t.w-i.x,d=i.x+i.w-t.x,p=t.y+t.h-i.y,s=i.y+i.h-t.y,h=Math.min(m,d),r=Math.min(p,s);return{overlapX:h,overlapY:r}}function G(i,t,m){return t>=0&&i<=m+.5}class X{model;onJump;onLand;onDie;prevJumpDown=!1;constructor(t){this.model=t??new b}update(t,m,d){const p=t.snapshot(),s=this.model.config,h=p.actions.Jump,r=p.move.x*s.moveSpeed,f=this.model.onGround;f||(this.model.velocity.x=r);const y=d*1e3;if(this.model.onGround?this.model.lastOnGroundMs=s.coyoteTimeMs:this.model.lastOnGroundMs>0&&(this.model.lastOnGroundMs=Math.max(0,this.model.lastOnGroundMs-y)),h&&!this.prevJumpDown?this.model.jumpBufferMs=s.jumpBufferMs:this.model.jumpBufferMs>0&&(this.model.jumpBufferMs=Math.max(0,this.model.jumpBufferMs-y)),this.model.jumpBufferMs>0&&(this.model.onGround||this.model.lastOnGroundMs>0)){const e=Math.min(1,Math.abs(this.model.velocity.x)/Math.max(1,s.moveSpeed)),a=e>=s.momentumMinSpeedRatio?1+s.momentumJumpMultiplier*(e-s.momentumMinSpeedRatio)/(1-s.momentumMinSpeedRatio):1;this.model.velocity.y=s.jumpVelocity*a,this.model.onGround=!1,this.model.jumpBufferMs=0,this.onJump?.()}this.model.velocity.y=Math.min(s.maxFallSpeed,this.model.velocity.y+s.gravity*d);const A=this.model.position.y+s.size.h,v=this.model.velocity.x,w=this.model.velocity.y;this.model.position.x+=this.model.velocity.x*d,this.model.position.y+=this.model.velocity.y*d;let l=this.model.getAabb();for(const e of m)if(!(e.removed||e.active===!1)&&e.type==="spike"&&u(l,e)){this.model.isDead=!0,this.onDie?.();return}let c=!1,o;for(const e of m){if(e.removed||e.active===!1||!u(l,e))continue;const n=D(l,e);if(n){if(n.overlapX<n.overlapY){if(e.oneWay)continue;l.x+l.w/2<e.x+e.w/2?this.model.position.x-=n.overlapX:this.model.position.x+=n.overlapX,this.model.velocity.x=0}else l.y+l.h/2<e.y+e.h/2?(!e.oneWay||G(A,this.model.velocity.y,e.y))&&(this.model.position.y-=n.overlapY,this.model.velocity.y=0,c=!0,o=e):e.oneWay||(this.model.position.y+=n.overlapY,this.model.velocity.y=0);l.x=this.model.position.x,l.y=this.model.position.y}}this.model.onGround=c,c&&o&&!f&&this.onLand?.(o);const M=typeof performance<"u"?performance.now():Date.now();if(c&&o){o.type==="falling"?(o.activated=!0,o.touchedAtMs=o.touchedAtMs??M):o.type==="crumble"&&(o.touchedAtMs=o.touchedAtMs??M),typeof o.conveyorSpeed=="number"&&(this.model.position.x+=o.conveyorSpeed*d);const e=g(o);(e.dx||e.dy)&&(this.model.position.x+=e.dx,this.model.position.y+=Math.min(0,e.dy))}if(c&&o){if(o.type==="bouncy"){const x=Math.max(.5,o.bounceMultiplier??1.2);this.model.velocity.y=s.jumpVelocity*x,this.model.onGround=!1}o.type==="breakable"&&(Math.abs(w)>=300||(o.hitPoints??1)<=1)&&(o.hitPoints=(o.hitPoints??1)-1,(o.hitPoints??0)<=0&&(o.removed=!0,o.active=!1));const e=Math.max(0,Math.min(1,o.frictionAlpha??1)),n=o.speedMultiplier??1,a=r*n;this.model.velocity.x=v+(a-v)*e}else this.model.velocity.x=r;if(!this.model.isDead){for(const e of m)if(!(e.removed||e.active===!1)&&e.type==="spike"&&u(this.model.getAabb(),e)){this.model.isDead=!0,this.onDie?.();break}}this.prevJumpDown=h}}export{X as PlayerController,X as default};
